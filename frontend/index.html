<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Code Assistant - RAG Powered</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 20px 30px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            color: #667eea;
            font-size: 28px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-badge {
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status-online {
            background: #d4edda;
            color: #155724;
        }

        .status-offline {
            background: #f8d7da;
            color: #721c24;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .status-online .status-dot {
            background: #28a745;
        }

        .status-offline .status-dot {
            background: #dc3545;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .card {
            background: white;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .card h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 22px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }
        .command-preview {
            margin-top: 20px;
        }

        .command-preview label {
            font-weight: 600;
            color: #333;
            display: block;
            margin-bottom: 8px;
        }

        .command-preview pre {
            background: #0f172a;
            color: #e2e8f0;
            padding: 16px;
            border-radius: 10px;
            font-size: 13px;
            line-height: 1.6;
            overflow-x: auto;
            border: 1px solid #1e293b;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        input[type="text"],
        textarea {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
            font-family: inherit;
        }

        input[type="text"]:focus,
        textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        textarea {
            resize: vertical;
            min-height: 120px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
            margin: 20px 0;
            display: none;
        }

        .progress-bar.active {
            display: block;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s;
            animation: shimmer 1.5s infinite;
        }

        @keyframes shimmer {
            0% { opacity: 0.6; }
            50% { opacity: 1; }
            100% { opacity: 0.6; }
        }

        .message {
            padding: 12px 16px;
            border-radius: 8px;
            margin: 15px 0;
            display: none;
        }

        .message.show {
            display: block;
            animation: slideIn 0.3s;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message-success {
            background: #d4edda;
            color: #155724;
            border-left: 4px solid #28a745;
        }

        .message-error {
            background: #f8d7da;
            color: #721c24;
            border-left: 4px solid #dc3545;
        }

        .message-info {
            background: #d1ecf1;
            color: #0c5460;
            border-left: 4px solid #17a2b8;
        }

        .message-warning {
            background: #fff3cd;
            color: #856404;
            border-left: 4px solid #ffc107;
        }

        .answer-box {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
            border-left: 4px solid #667eea;
            white-space: pre-wrap;
            font-size: 15px;
            line-height: 1.6;
            display: none;
        }

        .answer-box.show {
            display: block;
            animation: slideIn 0.3s;
        }

        .answer-box h3 {
            margin-bottom: 10px;
            color: #333;
        }

        .source-list {
            margin-top: 20px;
            border-top: 1px solid #e0e0e0;
            padding-top: 15px;
        }

        .source-item {
            background: #fff;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 12px 15px;
            margin-bottom: 12px;
        }

        .source-item strong {
            color: #333;
        }

        .source-item pre {
            background: #0f172a;
            color: #e2e8f0;
            padding: 12px;
            border-radius: 6px;
            margin-top: 8px;
            white-space: pre-wrap;
            font-size: 13px;
            line-height: 1.5;
        }

        .terminal-box {
            background: #1e1e1e;
            color: #00ff00;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
            font-family: 'Courier New', Courier, monospace;
            font-size: 13px;
            line-height: 1.5;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
            display: none;
            border: 2px solid #333;
        }

        .terminal-box.show {
            display: block;
            animation: slideIn 0.3s;
        }

        .terminal-box::-webkit-scrollbar {
            width: 10px;
        }

        .terminal-box::-webkit-scrollbar-track {
            background: #2d2d2d;
        }

        .terminal-box::-webkit-scrollbar-thumb {
            background: #555;
            border-radius: 5px;
        }

        .terminal-box::-webkit-scrollbar-thumb:hover {
            background: #777;
        }

        .terminal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #333;
            color: #888;
        }

        .terminal-mode-pill {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            color: #fff;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 12px;
            letter-spacing: 0.5px;
        }

        .terminal-title {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .terminal-dots {
            display: flex;
            gap: 6px;
        }

        .terminal-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        .terminal-dot.red { background: #ff5f56; }
        .terminal-dot.yellow { background: #ffbd2e; }
        .terminal-dot.green { background: #27c93f; }

        .terminal-line {
            margin: 2px 0;
        }

        .terminal-line.success {
            color: #00ff00;
        }

        .terminal-line.error {
            color: #ff5555;
        }

        .terminal-line.warning {
            color: #ffaa00;
        }

        .terminal-cursor {
            display: inline-block;
            width: 8px;
            height: 14px;
            background: #00ff00;
            animation: blink 1s infinite;
            margin-left: 2px;
        }

        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .stat-item {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-value {
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 14px;
            opacity: 0.9;
        }

        .advanced-options {
            margin-top: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            display: none;
        }

        .advanced-options.show {
            display: block;
        }

        .toggle-advanced {
            color: #667eea;
            cursor: pointer;
            font-size: 14px;
            text-decoration: underline;
            margin-bottom: 10px;
            display: inline-block;
        }

        .row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }

            .stats {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>
                <span>ü§ñ</span> Code Assistant
            </h1>
            <div id="statusBadge" class="status-badge status-offline">
                <span class="status-dot"></span>
                <span>Checking...</span>
            </div>
        </div>

        <!-- Indexing Card -->
        <div class="card">
            <h2>üìÅ Index Your Codebase</h2>

            <div class="form-group">
                <label for="codebasePath">Codebase Path *</label>
                <input 
                    type="text" 
                    id="codebasePath" 
                    placeholder="/path/to/your/codebase or ./my_codebase/mycarhub/src"
                    value="./my_codebase/mycarhub/src"
                >
            </div>

            <a href="#" class="toggle-advanced" onclick="toggleAdvanced(event)">‚öôÔ∏è Advanced Options</a>

            <div id="advancedOptions" class="advanced-options">
                <div class="row">
                    <div class="form-group">
                        <label for="collectionName">Collection Name</label>
                        <small style="color: #666; display: block; margin-bottom: 5px;">
                            üìÇ Unique identifier for this codebase index
                        </small>
                        <input 
                            type="text" 
                            id="collectionName" 
                            placeholder="code_assistant_local"
                            value="code_assistant_local"
                        >
                    </div>

                    <div class="form-group">
                        <label for="chunkSize">Chunk Size (characters)</label>
                        <small style="color: #666; display: block; margin-bottom: 5px;">
                            üìè How much code per chunk. Larger = more context but slower.
                            <br>üí° Recommended: 1000-1500 for most codebases
                        </small>
                        <input 
                            type="text" 
                            id="chunkSize" 
                            placeholder="1000"
                            value="1000"
                        >
                    </div>

                    <div class="form-group">
                        <label for="chunkOverlap">Chunk Overlap (characters)</label>
                        <small style="color: #666; display: block; margin-bottom: 5px;">
                            üîó Shared text between chunks to preserve context.
                            <br>üí° Usually 10-15% of chunk size (e.g., 100-150)
                        </small>
                        <input 
                            type="text" 
                            id="chunkOverlap" 
                            placeholder="100"
                            value="100"
                        >
                    </div>
                </div>
                
                <div style="background: #e7f3ff; border-left: 4px solid #2196F3; padding: 12px; margin-top: 15px; border-radius: 4px; font-size: 13px;">
                    <strong>‚ÑπÔ∏è Quick Guide:</strong>
                    <ul style="margin: 8px 0 0 20px; padding: 0;">
                        <li><strong>Chunk Size:</strong> Splits your code into pieces of this size. Smaller chunks = faster but less context. Larger chunks = slower but better understanding.</li>
                        <li><strong>Chunk Overlap:</strong> Duplicates text between chunks to avoid losing context at boundaries. Helps the AI understand code that spans multiple chunks.</li>
                        <li><strong>Example:</strong> With size 1000 and overlap 100, a 2000 character file becomes 2 chunks: [0-1000] and [900-1900]</li>
                    </ul>
                </div>
            </div>

            <div class="command-preview">
                <label>Equivalent CLI Command</label>
                <pre id="commandPreview">python3.9 scripts/index_codebase_local.py ./my_codebase/mycarhub/src \
  --collection code_assistant_local \
  --chunk-size 1000 \
  --chunk-overlap 100 \
  --output ./chroma_db_local</pre>
            </div>

            <button class="btn btn-primary" onclick="startIndexing()" id="indexBtn">
                ‚ñ∂Ô∏è Start Indexing
            </button>

            <div id="indexProgress" class="progress-bar">
                <div class="progress-fill" style="width: 100%"></div>
            </div>

            <div id="indexMessage" class="message"></div>

            <div id="terminalBox" class="terminal-box">
                <div class="terminal-header">
                    <div class="terminal-dots">
                        <span class="terminal-dot red"></span>
                        <span class="terminal-dot yellow"></span>
                        <span class="terminal-dot green"></span>
                    </div>
                    <div class="terminal-title">
                        <span>üìü</span>
                        <span>Indexing Terminal Output</span>
                        <span id="terminalModeLabel" class="terminal-mode-pill">LOCAL</span>
                    </div>
                </div>
                <div id="terminalContent"></div>
            </div>
        </div>

        <!-- Question Card -->
        <div class="card">
            <h2>üí¨ Ask Questions</h2>
            
            <div class="form-group">
                <label for="question">Your Question</label>
                <textarea 
                    id="question" 
                    placeholder="What components are in this React app?"
                >What components are in this React app?</textarea>
            </div>

            <button class="btn btn-primary" onclick="askQuestion()" id="askBtn">
                üîç Ask Question
            </button>

            <div id="askMessage" class="message"></div>
            <div id="answerBox" class="answer-box"></div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8000';
        const INDEX_SCRIPT = 'scripts/index_codebase.py';
        const DEFAULT_COLLECTION = 'code_assistant_local';
        const DEFAULT_OUTPUT = './chroma_db';
        let outputPollingInterval = null;
        let statusMonitorInterval = null;

        const collectionInputEl = document.getElementById('collectionName');
        const pathInputEl = document.getElementById('codebasePath');
        const chunkSizeEl = document.getElementById('chunkSize');
        const chunkOverlapEl = document.getElementById('chunkOverlap');

        if (collectionInputEl) {
            collectionInputEl.dataset.userEdited = 'false';
            collectionInputEl.dataset.currentDefault = collectionInputEl.value || DEFAULT_COLLECTION;
            collectionInputEl.addEventListener('input', () => {
                collectionInputEl.dataset.userEdited = 'true';
                updateCommandPreview();
            });
        }

        [pathInputEl, chunkSizeEl, chunkOverlapEl].forEach((input) => {
            if (input) {
                input.addEventListener('input', updateCommandPreview);
            }
        });

        window.addEventListener('load', () => {
            checkServerStatus();
            loadStats();
            updateCommandPreview();
        });

        function toggleAdvanced(e) {
            e.preventDefault();
            const options = document.getElementById('advancedOptions');
            options.classList.toggle('show');
        }

        async function checkServerStatus() {
            const statusBadge = document.getElementById('statusBadge');
            try {
                const response = await fetch(`${API_BASE}/`);
                if (response.ok) {
                    statusBadge.className = 'status-badge status-online';
                    statusBadge.innerHTML = '<span class="status-dot"></span><span>Online</span>';
                } else {
                    throw new Error('Server error');
                }
            } catch (error) {
                statusBadge.className = 'status-badge status-offline';
                statusBadge.innerHTML = '<span class="status-dot"></span><span>Offline</span>';
            }
        }

        async function loadStats() {
            // Stats card was removed; keep placeholder for future use
            return;
        }

        function showMessage(elementId, text, type) {
            const element = document.getElementById(elementId);
            element.className = `message message-${type} show`;
            element.textContent = text;
        }

        function hideMessage(elementId) {
            const element = document.getElementById(elementId);
            element.className = 'message';
        }

        function formatTerminalLine(line) {
            let className = 'terminal-line';
            if (line.includes('‚úì') || line.includes('‚úÖ') || line.includes('SUCCESS')) {
                className += ' success';
            } else if (line.includes('‚ùå') || line.includes('ERROR') || line.includes('Error')) {
                className += ' error';
            } else if (line.includes('‚ö†Ô∏è') || line.includes('WARNING') || line.includes('Warning')) {
                className += ' warning';
            }
            return `<div class="${className}">${escapeHtml(line)}</div>`;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        async function updateTerminalOutput() {
            try {
                const response = await fetch(`${API_BASE}/index/output`);
                const data = await response.json();
                const terminalBox = document.getElementById('terminalBox');
                const terminalContent = document.getElementById('terminalContent');
                if (data.output && data.output.length > 0) {
                    terminalBox.classList.add('show');
                    let html = '';
                    data.output.forEach(line => {
                        html += formatTerminalLine(line);
                    });
                    if (data.in_progress) {
                        html += '<span class="terminal-cursor"></span>';
                    }
                    terminalContent.innerHTML = html;
                    terminalBox.scrollTop = terminalBox.scrollHeight;
                }
                if (data.completed || !data.in_progress) {
                    if (outputPollingInterval) {
                        clearInterval(outputPollingInterval);
                        outputPollingInterval = null;
                    }
                }
            } catch (error) {
                console.error('Error fetching output:', error);
            }
        }

        function startOutputPolling() {
            if (outputPollingInterval) {
                clearInterval(outputPollingInterval);
            }
            updateTerminalOutput();
            outputPollingInterval = setInterval(updateTerminalOutput, 1000);
        }

        function stopOutputPolling() {
            if (outputPollingInterval) {
                clearInterval(outputPollingInterval);
                outputPollingInterval = null;
            }
        }

        function monitorIndexingStatus() {
            if (statusMonitorInterval) {
                clearInterval(statusMonitorInterval);
            }
            statusMonitorInterval = setInterval(async () => {
                try {
                    const resp = await fetch(`${API_BASE}/index/status`);
                    const status = await resp.json();
                    if (!status.in_progress) {
                        clearInterval(statusMonitorInterval);
                        statusMonitorInterval = null;
                        const indexBtn = document.getElementById('indexBtn');
                        indexBtn.disabled = false;
                        indexBtn.innerHTML = '‚ñ∂Ô∏è Start Indexing';
                        document.getElementById('indexProgress').classList.remove('active');
                        if (status.completed) {
                            showMessage('indexMessage', '‚úÖ Indexing completed successfully!', 'success');
                        } else {
                            showMessage('indexMessage', '‚ö†Ô∏è Indexing stopped. Check terminal output for details.', 'warning');
                        }
                    }
                } catch (err) {
                    console.error('Status polling error', err);
                }
            }, 2000);
        }

        function updateCommandPreview() {
            const previewEl = document.getElementById('commandPreview');
            if (!previewEl) return;
            const path = pathInputEl?.value || './path/to/codebase';
            const collection = collectionInputEl?.value || DEFAULT_COLLECTION;
            const chunkSize = chunkSizeEl?.value || '1000';
            const chunkOverlap = chunkOverlapEl?.value || '100';
            let cmd = `python3.9 ${INDEX_SCRIPT} "${path}" \
  --collection ${collection} \
  --chunk-size ${chunkSize} \
  --chunk-overlap ${chunkOverlap} \
  --output ${DEFAULT_OUTPUT}`;
            previewEl.textContent = cmd;
        }

        async function startIndexing() {
            const path = pathInputEl.value;
            const collection = collectionInputEl.value;
            const chunkSize = chunkSizeEl.value;
            const chunkOverlap = chunkOverlapEl.value;
            if (!path) {
                showMessage('indexMessage', '‚ùå Please enter a codebase path', 'error');
                return;
            }
            const indexBtn = document.getElementById('indexBtn');
            const progress = document.getElementById('indexProgress');
            const terminalBox = document.getElementById('terminalBox');
            const terminalContent = document.getElementById('terminalContent');
            stopOutputPolling();
            if (statusMonitorInterval) {
                clearInterval(statusMonitorInterval);
                statusMonitorInterval = null;
            }
            indexBtn.disabled = true;
            indexBtn.innerHTML = '<span class="spinner"></span> Indexing...';
            progress.classList.add('active');
            hideMessage('indexMessage');
            terminalBox.classList.add('show');
            terminalContent.innerHTML = '<div class="terminal-line">Initializing...</div><span class="terminal-cursor"></span>';
            try {
                const response = await fetch(`${API_BASE}/index`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        codebase_path: path,
                        collection: collection || null,
                        chunk_size: parseInt(chunkSize) || 1000,
                        chunk_overlap: parseInt(chunkOverlap) || 100,
                    })
                });
                const result = await response.json();
                if (response.ok) {
                    showMessage('indexMessage', '‚è≥ ' + result.message, 'info');
                    startOutputPolling();
                    monitorIndexingStatus();
                } else {
                    showMessage('indexMessage', '‚ùå ' + (result.error || result.detail || 'Indexing failed'), 'error');
                    terminalBox.classList.remove('show');
                    indexBtn.disabled = false;
                    indexBtn.innerHTML = '‚ñ∂Ô∏è Start Indexing';
                    progress.classList.remove('active');
                }
            } catch (error) {
                showMessage('indexMessage', '‚ùå Connection error: ' + error.message, 'error');
                terminalBox.classList.remove('show');
                indexBtn.disabled = false;
                indexBtn.innerHTML = '‚ñ∂Ô∏è Start Indexing';
                progress.classList.remove('active');
            }
        }

        async function askQuestion() {
            const question = document.getElementById('question').value;
            if (!question.trim()) {
                showMessage('askMessage', '‚ùå Please enter a question', 'error');
                return;
            }
            const askBtn = document.getElementById('askBtn');
            const answerBox = document.getElementById('answerBox');
            askBtn.disabled = true;
            askBtn.innerHTML = '<span class="spinner"></span> Thinking...';
            hideMessage('askMessage');
            answerBox.classList.remove('show');
            try {
                const response = await fetch(`${API_BASE}/ask`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ question })
                });
                const result = await response.json();
                if (result.answer) {
                    const sources = result.sources || [];
                    let html = `<h3>Answer</h3><p>${escapeHtml(result.answer)}</p>`;
                    if (sources.length) {
                        html += '<div class="source-list"><h3>Sources</h3>';
                        sources.forEach((src, idx) => {
                            const contentPreview = (src.content || '').slice(0, 600);
                            html += `
                                <div class="source-item">
                                    <strong>${escapeHtml(src.source || `Snippet ${idx + 1}`)}</strong>
                                    <pre>${escapeHtml(contentPreview)}${src.content && src.content.length > 600 ? '\\n...' : ''}</pre>
                                </div>
                            `;
                        });
                        html += '</div>';
                    }
                    answerBox.innerHTML = html;
                    answerBox.classList.add('show');
                } else if (result.error) {
                    showMessage('askMessage', '‚ùå ' + result.error, 'error');
                }
            } catch (error) {
                showMessage('askMessage', '‚ùå Connection error: ' + error.message, 'error');
            } finally {
                askBtn.disabled = false;
                askBtn.innerHTML = 'üîç Ask Question';
            }
        }

        document.getElementById('question').addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && e.ctrlKey) {
                askQuestion();
            }
        });
    </script></script>
</body>
</html>

</script>